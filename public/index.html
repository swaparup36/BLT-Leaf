<!DOCTYPE html>
<html lang="en" class="">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PR Readiness Checker - BLT-Leaf</title>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        /* Fallback visibility if CDN is blocked */
        .btn-fallback {
            background: #E10000;
            color: #fff;
            border: 1px solid #BC0000;
        }
    </style>
</head>

<body class="flex min-h-screen flex-col bg-slate-50 text-slate-900 antialiased dark:bg-slate-900 dark:text-slate-100">
    <header class="sticky top-0 z-30 border-b border-slate-200 bg-white px-5 dark:border-slate-700 dark:bg-slate-800">
        <div class="mx-auto flex h-16 items-center justify-between px-4 sm:px-6 lg:px-8">
            
            <div class="flex items-center gap-4 lg:gap-6">
                <a href="/" class="flex shrink-0 items-center gap-2 hover:opacity-80 transition-opacity">
                    <img width="28" src="./static/logo.png" alt="Logo" onerror="this.style.display='none'" />
                    <h1 class="hidden font-bold text-slate-900 dark:text-white sm:block">BLT-LEAF</h1>
                </a>

                <div class="hidden items-center gap-2 sm:flex pl-4 border-l border-slate-200 dark:border-slate-700 h-8">
                    <span class="text-[10px] font-medium text-slate-500 dark:text-slate-400">API Limit:</span>
                    <div class="rate-limit-bar h-1.5 w-20 overflow-hidden rounded-full bg-slate-200 dark:bg-slate-700">
                        <div class="h-full w-0 rounded-full bg-green-500 transition-all duration-300" id="rateLimitFill"></div>
                    </div>
                    <span class="text-[10px] font-semibold text-slate-500 dark:text-slate-400" id="rateLimitText">N/A</span>
                </div>
            </div>

            <div class="flex flex-1 items-center justify-center px-4 md:px-8 lg:px-12">
                <div class="relative w-full max-w-lg">
                    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                        <i class="fas fa-search text-slate-400"></i>
                    </div>
                    <input type="text" id="prSearchInput"
                        class="block w-full rounded-md border border-[#e74c3c] bg-slate-50 py-2 pl-10 pr-3 text-sm text-slate-900 placeholder:text-slate-500 dark:border-[#e74c3c] dark:bg-slate-900 dark:text-white dark:placeholder:text-slate-400 dark:focus:border-red-500 transition-colors shadow-sm"
                        placeholder="Search PRs..." autocomplete="off">
                </div>
            </div>

            <div class="flex shrink-0 items-center gap-3">
                <button id="themeToggle" class="rounded-lg p-2 text-slate-500 hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-slate-200 dark:text-slate-400 dark:hover:bg-slate-700 dark:focus:ring-slate-600">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
                <span id="releaseVersion" class="hidden text-xs text-slate-500 dark:text-slate-400 md:inline-block"></span>
                <a href="https://github.com/OWASP-BLT/BLT-Leaf" target="_blank" rel="noopener noreferrer"
                   class="hidden rounded-lg bg-red-600 px-3 py-2 text-sm font-semibold text-white hover:bg-red-700 md:inline-flex items-center gap-2 transition-colors shadow-sm">
                    <i class="fab fa-github"></i> <span>Contribute</span>
                </a>
            </div>
        </div>
    </header>

    <div class="bg-gradient-to-r from-red-50 to-orange-50 border-b border-red-100">
        <div class="mx-auto max-w-7xl px-4 py-4 sm:px-6 sm:py-5">
            <p class="text-sm text-slate-700 leading-relaxed sm:text-base">
                Leaf is a Readiness and Security PR checker. It reviews pull requests for operational readiness, security risks, and production-impacting changes before they ship. Inspired by the surge of AI-generated PRs, Leaf helps teams maintain high standards by adding an automated layer of critical thinking and risk detection to every change.
            </p>
        </div>
    </div>

    <div class="mx-auto flex min-h-0 w-full flex-1 flex-col md:flex-row">
        <aside class="w-full border-b border-slate-200 bg-white md:w-72 md:border-b-0 md:border-r dark:border-slate-700 dark:bg-slate-800">
            <div class="p-4">
                <h2 class="mb-3 text-xs font-semibold uppercase tracking-[0.12em] text-slate-500 dark:text-slate-400">Repositories <span id="repoCountDisplay"></span></h2>
                <ul id="repoList" class="space-y-2">
                    <li class="repo-item active cursor-pointer rounded-lg border border-[#f5b0b0] bg-[#fff1f1] px-3 py-2 dark:border-red-900 dark:bg-red-950/30" data-repo="all">
                        <div class="repo-name text-sm font-semibold text-[#BC0000] dark:text-red-400">All Repositories</div>
                        <div class="repo-count mt-0.5 text-xs text-slate-500 dark:text-slate-400" id="allReposCount">0 PRs</div>
                    </li>
                </ul>
            </div>  
        </aside>

        <main class="min-h-0 flex-1 overflow-y-auto p-4 sm:p-6">
            <section class="mb-6 space-y-3">
                <div class="flex w-full max-w-4xl flex-col gap-2 sm:flex-row">
                    <input type="text" id="prUrlInput"
                        class="w-full rounded-lg border border-slate-300 bg-white px-3 py-2.5 text-sm text-slate-900 placeholder:text-slate-400 focus:border-[#E10000] focus:outline-none focus:ring-2 focus:ring-[#ffe3e3] dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 dark:placeholder:text-slate-500 dark:focus:ring-red-900/50"
                        placeholder="Enter GitHub PR URL or Repository URL"
                        autocomplete="off" />
                    <button id="addPrBtn"
                        class="btn-fallback w-[6rem] rounded-lg px-4 py-2.5 text-sm font-semibold transition-colors hover:bg-[#BC0000] disabled:cursor-not-allowed disabled:border-red-300 disabled:bg-red-200 disabled:text-red-700 dark:disabled:border-red-800 dark:disabled:bg-red-950 dark:disabled:text-red-400">
                        Add PR
                    </button>
                </div>
                
                <div class="mt-2 flex items-center gap-2">
                    <input type="checkbox" id="addAllPrsCheckbox"
                        class="h-4 w-4 rounded border-slate-300 text-[#E10000] focus:ring-[#E10000] dark:border-slate-600 dark:bg-slate-700">
                    <label for="addAllPrsCheckbox"
                        class="text-sm text-slate-600 dark:text-slate-400 cursor-pointer select-none">
                        Add all active PRs from this repo
                    </label>
                </div>                
            </section>

            <div id="prListContainer">
                <div class="rounded-xl border border-dashed border-slate-300 bg-white p-10 text-center dark:border-slate-600 dark:bg-slate-800">
                    <h3 class="text-xl font-semibold text-slate-900 dark:text-slate-100">No PRs Added Yet</h3>
                    <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">Add a GitHub PR URL above to start tracking</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        let currentRepo = localStorage.getItem('currentRepo') || 'all';
        let allPrs = [];
        let repos = [];
        let sortColumn = localStorage.getItem('sortColumn') || 'ready_score';
        let sortDirection = localStorage.getItem('sortDirection') || 'desc';
        let secondarySortColumn = null;
        let secondarySortDirection = 'desc';

        // Helper functions for readiness data persistence
        function saveReadinessData(prId, readiness, reviewHealth) {
            try {
                const data = JSON.parse(localStorage.getItem('prReadinessData') || '{}');
                data[prId] = {
                    readiness,
                    reviewHealth,
                    timestamp: Date.now()
                };
                localStorage.setItem('prReadinessData', JSON.stringify(data));
                
                // Also update the PR object in allPrs for sorting
                const pr = allPrs.find(p => p.id === prId);
                if (pr) {
                    pr.ready_score = readiness.overall_score;
                    pr.ci_score = readiness.ci_score;
                    pr.review_score = readiness.review_score;
                    pr.response_score = parseFloat(reviewHealth.response_rate_display.replace('%', ''));
                    pr.feedback_score = reviewHealth.total_feedback > 0 ? 
                        (reviewHealth.responded_feedback / reviewHealth.total_feedback) * 100 : 100;
                    pr.issues_count = (readiness.blockers?.length || 0) + (readiness.warnings?.length || 0);
                }
            } catch (error) {
                console.error('Error saving readiness data:', error);
            }
        }

        function loadReadinessData(prId) {
            try {
                const data = JSON.parse(localStorage.getItem('prReadinessData') || '{}');
                return data[prId] || null;
            } catch (error) {
                console.error('Error loading readiness data:', error);
                return null;
            }
        }

        function clearReadinessData(prId) {
            try {
                const data = JSON.parse(localStorage.getItem('prReadinessData') || '{}');
                delete data[prId];
                localStorage.setItem('prReadinessData', JSON.stringify(data));
            } catch (error) {
                console.error('Error clearing readiness data:', error);
            }
        }

        const repoItemBaseClasses = ['repo-item', 'cursor-pointer', 'rounded-lg', 'border', 'px-3', 'py-2', 'transition-colors'];
        const repoItemIdleClasses = ['border-slate-200', 'bg-white', 'hover:border-slate-300', 'hover:bg-slate-50', 'dark:border-slate-700', 'dark:bg-slate-800', 'dark:hover:border-slate-600', 'dark:hover:bg-slate-700'];
        const repoItemActiveClasses = ['active', 'border-[#f5b0b0]', 'bg-[#fff1f1]', 'dark:border-red-900', 'dark:bg-red-950/30'];

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function setRepoItemActiveState(item, isActive) {
            item.className = '';
            item.classList.add(...repoItemBaseClasses);
            item.classList.add(...(isActive ? repoItemActiveClasses : repoItemIdleClasses));

            const nameEl = item.querySelector('.repo-name');
            if (nameEl) {
                nameEl.className = `repo-name text-sm font-semibold ${isActive ? 'text-[#BC0000] dark:text-red-400' : 'text-slate-800 dark:text-slate-200'}`;
            }
        }

        async function loadRateLimit() {
            try {
                const response = await fetch('/api/rate-limit');
                const textEl = document.getElementById('rateLimitText');
                const fillEl = document.getElementById('rateLimitFill');

                if (!response.ok) {
                    if(textEl) textEl.textContent = 'N/A';
                    return;
                }

                const data = await response.json();
                if (data.error) {
                    if(textEl) textEl.textContent = 'N/A';
                    return;
                }

                const { limit, remaining } = data;
                if (typeof limit !== 'number' || typeof remaining !== 'number') {
                    if(textEl) textEl.textContent = 'N/A';
                    return;
                }

                const percentageRemaining = (remaining / limit) * 100;
                
                if (fillEl) {
                    fillEl.style.width = `${percentageRemaining}%`;
                    fillEl.className = 'h-full rounded-full transition-all duration-300';
                    if (percentageRemaining < 20) {
                        fillEl.classList.add('bg-red-600');
                    } else if (percentageRemaining <= 50) {
                        fillEl.classList.add('bg-amber-500');
                    } else {
                        fillEl.classList.add('bg-green-500');
                    }
                }
                
                if(textEl) textEl.textContent = `${remaining} / ${limit}`;

            } catch (error) {
                console.error('Error loading rate limit:', error);
                const textEl = document.getElementById('rateLimitText');
                if(textEl) textEl.textContent = 'N/A';
            }
        }

        async function loadLatestRelease() {
            try {
                const response = await fetch('https://api.github.com/repos/OWASP-BLT/BLT-Leaf/releases/latest');

                if (!response.ok) {
                    return; // Silently fail - don't show version if API fails
                }

                const data = await response.json();
                const versionEl = document.getElementById('releaseVersion');
                
                if (data.tag_name && versionEl) {
                    versionEl.textContent = data.tag_name;
                    versionEl.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading latest release:', error);
                // Silently fail - don't show version if fetch fails
            }
        }

        function timeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            const intervals = {
                year: 31536000,
                month: 2592000,
                week: 604800,
                day: 86400,
                hour: 3600,
                minute: 60
            };

            for (const [name, value] of Object.entries(intervals)) {
                const interval = Math.floor(seconds / value);
                if (interval >= 1) return `${interval} ${name}${interval === 1 ? '' : 's'} ago`;
            }

            return 'just now';
        }

        function sortPrs(column, isShiftClick = false) {
            // Handle shift+click for secondary sort
            if (isShiftClick) {
                if (secondarySortColumn === column) {
                    // Toggle direction of secondary sort
                    secondarySortDirection = secondarySortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    // Set as new secondary sort column
                    secondarySortColumn = column;
                    secondarySortDirection = 'desc';
                }
            } else {
                // Regular click - set as primary sort
                if (sortColumn === column) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = column;
                    sortDirection = 'desc';
                }
                // If the new primary sort was the secondary sort, clear secondary
                if (secondarySortColumn === column) {
                    secondarySortColumn = null;
                }
            }
            
            // Save sorting state to localStorage
            localStorage.setItem('sortColumn', sortColumn);
            localStorage.setItem('sortDirection', sortDirection);
            
            // Columns that should use numeric sorting
            const numericColumns = ['files_changed', 'commits_count', 'behind_by', 'checks_passed', 'checks_failed', 'checks_skipped', 'pr_number', 'ready_score', 'ci_score', 'review_score', 'response_score', 'feedback_score', 'issues_count'];

            allPrs.sort((a, b) => {
                // Primary sort comparison
                let aVal = a[sortColumn];
                let bVal = b[sortColumn];
                
                // Handle numeric columns
                if (numericColumns.includes(sortColumn)) {
                    aVal = Number(aVal) || 0;
                    bVal = Number(bVal) || 0;
                }
                // Handle string comparisons for all other columns 
                else {
                    aVal = String(aVal || '').toLowerCase();
                    bVal = String(bVal || '').toLowerCase();
                }
                
                let result;
                if (sortDirection === 'asc') {
                    result = aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    result = aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
                
                // If primary sort values are equal and secondary sort is set, use secondary sort
                if (result === 0 && secondarySortColumn) {
                    let aSecVal = a[secondarySortColumn];
                    let bSecVal = b[secondarySortColumn];
                    
                    if (numericColumns.includes(secondarySortColumn)) {
                        aSecVal = Number(aSecVal) || 0;
                        bSecVal = Number(bSecVal) || 0;
                    } else {
                        aSecVal = String(aSecVal || '').toLowerCase();
                        bSecVal = String(bSecVal || '').toLowerCase();
                    }
                    
                    if (secondarySortDirection === 'asc') {
                        result = aSecVal > bSecVal ? 1 : aSecVal < bSecVal ? -1 : 0;
                    } else {
                        result = aSecVal < bSecVal ? 1 : aSecVal > bSecVal ? -1 : 0;
                    }
                }
                
                return result;
            });
            
            // Re-apply filter after sorting
            const searchTerm = document.getElementById('prSearchInput').value;
            filterPrs(searchTerm);
        }

        function showInlineError(rowId, message) {
            // Show error message in the specific PR row
            const row = document.getElementById(rowId);
            if (!row) return;

            // Create error cell that spans all columns
            const errorCell = document.createElement('td');
            errorCell.colSpan = 17; // Total number of columns in the table
            errorCell.className = 'px-2 py-3';
            errorCell.innerHTML = `
                <div class="flex items-start gap-2 rounded-lg border border-red-200 border-l-4 border-l-red-600 bg-red-50 px-3 py-2.5 text-sm text-red-900 dark:border-red-900 dark:bg-red-950/30 dark:text-red-400">
                    <span class="inline-flex h-5 w-5 flex-shrink-0 items-center justify-center rounded-full bg-red-100 text-xs font-bold text-red-700 dark:bg-red-900 dark:text-red-400">!</span>
                    <div class="leading-5">${escapeHtml(message)}</div>
                </div>
            `;

            // Replace all cells with the error cell
            row.innerHTML = '';
            row.appendChild(errorCell);
        }

        function showContainerError(containerId, message) {
            // Show error message in a container (for loading errors)
            const container = document.getElementById(containerId);
            if (!container) return;

            container.innerHTML = `
                <div class="rounded-xl border border-red-200 bg-white p-8 dark:border-red-900 dark:bg-slate-800">
                    <div class="flex items-start gap-3">
                        <span class="inline-flex h-8 w-8 flex-shrink-0 items-center justify-center rounded-full bg-red-100 text-sm font-bold text-red-700 dark:bg-red-900 dark:text-red-400">!</span>
                        <div>
                            <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100 mb-2">Error</h3>
                            <p class="text-sm text-slate-700 dark:text-slate-300">${escapeHtml(message)}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function showInputError(inputId, message) {
            // Show error message near an input field
            const input = document.getElementById(inputId);
            if (!input) return;

            // Remove any existing error message
            const container = input.closest('section');
            const existingError = container.querySelector('.input-error-message');
            if (existingError) {
                existingError.remove();
            }

            // Create error message element
            const errorElement = document.createElement('div');
            errorElement.className = 'input-error-message flex items-start gap-2 rounded-lg border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-900 dark:border-red-900 dark:bg-red-950/30 dark:text-red-400 w-full max-w-4xl';
            errorElement.innerHTML = `
                <span class="inline-flex h-5 w-5 flex-shrink-0 items-center justify-center rounded-full bg-red-100 text-xs font-bold text-red-700 dark:bg-red-900 dark:text-red-400">!</span>
                <div class="leading-5">${escapeHtml(message)}</div>
            `;

            // Insert after the parent flex div
            const parentDiv = input.parentElement;
            parentDiv.after(errorElement);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                errorElement.remove();
            }, 5000);
        }

        async function loadRepos() {
            try {
                const response = await fetch('/api/repos');
                const data = await response.json();

                if (data.error) {
                    console.error('Error loading repos:', data.error);
                    return;
                }

                repos = data.repos;
                renderRepoList();
            } catch (error) {
                console.error('Error loading repos:', error);
            }
        }

        function renderRepoList() {
            const repoList = document.getElementById('repoList');
            const allReposCount = document.getElementById('allReposCount');
            const repoCountDisplay = document.getElementById('repoCountDisplay');
            const totalPrs = allPrs.length;
            allReposCount.textContent = `${totalPrs} PR${totalPrs === 1 ? '' : 's'}`;

            // Update the repository count display
            const repoCount = repos.length;
            repoCountDisplay.textContent = repoCount > 0 ? `(${repoCount})` : '';

            while (repoList.children.length > 1) repoList.removeChild(repoList.lastChild);

            const allItem = repoList.querySelector('[data-repo="all"]');
            if (allItem) setRepoItemActiveState(allItem, currentRepo === 'all');

            repos.forEach(repo => {
                const li = document.createElement('li');
                li.dataset.repo = `${repo.repo_owner}/${repo.repo_name}`;
                setRepoItemActiveState(li, currentRepo === li.dataset.repo);

                li.innerHTML = `
                    <div class="repo-name text-sm font-semibold text-slate-800 dark:text-slate-200">${repo.repo_owner}/${repo.repo_name}</div>
                    <div class="repo-count mt-0.5 text-xs text-slate-500 dark:text-slate-400">${repo.pr_count} PR${repo.pr_count === 1 ? '' : 's'}</div>
                `;

                li.addEventListener('click', () => {
                    currentRepo = li.dataset.repo;
                    localStorage.setItem('currentRepo', currentRepo);
                    document.querySelectorAll('.repo-item').forEach(item => {
                        setRepoItemActiveState(item, item.dataset.repo === currentRepo);
                    });
                    loadPrs();
                });

                repoList.appendChild(li);
            });
        }

        async function loadPrs() {
            const container = document.getElementById('prListContainer');
            // Only show spinner if search is empty to avoid flickering while typing
            if(document.getElementById('prSearchInput').value.trim() === '') {
                container.innerHTML = `
                    <div class="flex items-center justify-center gap-2 rounded-xl border border-slate-200 bg-white p-8 text-sm text-slate-500 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-400">
                        <span class="inline-block h-4 w-4 animate-spin rounded-full border-2 border-slate-300 border-t-slate-500 dark:border-slate-600 dark:border-t-slate-400"></span>
                        Loading PRs...
                    </div>
                `;
            }

            try {
                const url = currentRepo === 'all' ? '/api/prs' : `/api/prs?repo=${encodeURIComponent(currentRepo)}`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.error) {
                    showContainerError('prListContainer', data.error);
                    return;
                }

                allPrs = data.prs;
                
                // Attach readiness data from localStorage to each PR for sorting
                allPrs.forEach(pr => {
                    const storedData = loadReadinessData(pr.id);
                    if (storedData && storedData.readiness && storedData.reviewHealth) {
                        pr.ready_score = storedData.readiness.overall_score;
                        pr.ci_score = storedData.readiness.ci_score;
                        pr.review_score = storedData.readiness.review_score;
                        pr.response_score = parseFloat(storedData.reviewHealth.response_rate_display.replace('%', ''));
                        pr.feedback_score = storedData.reviewHealth.total_feedback > 0 ? 
                            (storedData.reviewHealth.responded_feedback / storedData.reviewHealth.total_feedback) * 100 : 100;
                        pr.issues_count = (storedData.readiness.blockers?.length || 0) + (storedData.readiness.warnings?.length || 0);
                    }
                });
                
                // Apply initial sort based on saved preferences or defaults
                const numericColumns = ['files_changed', 'commits_count', 'behind_by', 'checks_passed', 'checks_failed', 'checks_skipped', 'pr_number', 'ready_score', 'ci_score', 'review_score', 'response_score', 'feedback_score', 'issues_count'];
                allPrs.sort((a, b) => {
                    let aVal = a[sortColumn];
                    let bVal = b[sortColumn];
                    
                    if (numericColumns.includes(sortColumn)) {
                        aVal = Number(aVal) || 0;
                        bVal = Number(bVal) || 0;
                    } else {
                        aVal = String(aVal || '').toLowerCase();
                        bVal = String(bVal || '').toLowerCase();
                    }
                    
                    if (sortDirection === 'asc') {
                        return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                    } else {
                        return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                    }
                });
                
                // Apply search filter if exists
                const searchTerm = document.getElementById('prSearchInput').value;
                if(searchTerm) {
                    filterPrs(searchTerm);
                } else {
                    renderPrList(allPrs);
                }
            } catch (error) {
                console.error('Error loading PRs:', error);
                showContainerError('prListContainer', 'Failed to load PRs');
            }
        }
        
        function filterPrs(searchTerm) {
            const term = searchTerm.toLowerCase();
            const filtered = allPrs.filter(pr =>
                (pr.title && pr.title.toLowerCase().includes(term)) ||
                (pr.author_login && pr.author_login.toLowerCase().includes(term)) ||
                (pr.repo_name && pr.repo_name.toLowerCase().includes(term)) ||
                String(pr.pr_number).includes(term)
            );
            renderPrList(filtered);
        }

        function renderPrList(prsToRender) {
            const container = document.getElementById('prListContainer');
            // Use the passed filtered list OR fallback to allPrs
            const prs = prsToRender || allPrs;

            if (prs.length === 0) {
                const isFiltered = document.getElementById('prSearchInput').value.trim() !== '';
                const emptyTitle = isFiltered ? "No PRs Match" : "No PRs Added Yet";
                container.innerHTML = `
                    <div class="rounded-xl border border-dashed border-slate-300 bg-white p-10 text-center dark:border-slate-600 dark:bg-slate-800">
                        <h3 class="text-xl font-semibold text-slate-900 dark:text-slate-100">${emptyTitle}</h3>
                        <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">Add a GitHub PR URL above to start tracking</p>
                    </div>
                `;
                return;
            }

            const getSortIcon = (column) => {
                const isPrimary = sortColumn === column;
                const isSecondary = secondarySortColumn === column;
                
                if (isPrimary) {
                    const primaryIcon = sortDirection === 'asc' 
                        ? '<i class="fas fa-sort-up text-[#BC0000] dark:text-red-400 ml-1"></i>'
                        : '<i class="fas fa-sort-down text-[#BC0000] dark:text-red-400 ml-1"></i>';
                    return primaryIcon;
                }
                
                if (isSecondary) {
                    const secondaryIcon = secondarySortDirection === 'asc'
                        ? '<i class="fas fa-sort-up text-slate-500 dark:text-slate-400 ml-1" style="font-size: 0.75em;"></i>'
                        : '<i class="fas fa-sort-down text-slate-500 dark:text-slate-400 ml-1" style="font-size: 0.75em;"></i>';
                    return '<sup class="text-xs text-slate-500 dark:text-slate-400">2</sup>' + secondaryIcon;
                }
                
                return '<i class="fas fa-sort text-slate-400 ml-1"></i>';
            };

            container.innerHTML = `
                <div class="rounded-xl border border-slate-200 bg-white dark:border-slate-700 dark:bg-slate-800" style="overflow-x: auto;">
                    <table class="w-full text-left text-sm" style="min-width: 1750px;">
                        <thead class="border-b border-slate-200 bg-slate-50 text-xs font-semibold uppercase tracking-wider text-slate-700 dark:border-slate-700 dark:bg-slate-900/50 dark:text-slate-300">
                            <tr>
                                <th class="cursor-pointer px-2 py-3 hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="author_login" style="min-width: 100px;" title="Click to sort by Author. Shift+Click to set as secondary sort.&#10;API: GET /repos/{owner}/{repo}/pulls/{pr_number} (user.login field)">
                                    <div class="flex items-center gap-1 truncate">
                                        <span class="truncate">Author</span> ${getSortIcon('author_login')}
                                    </div>
                                </th>
                                <th class="cursor-pointer px-2 py-3 hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="title" style="min-width: 200px;" title="Click to sort by PR Title. Shift+Click to set as secondary sort.&#10;API: GET /repos/{owner}/{repo}/pulls/{pr_number} (title field)">
                                    <div class="flex items-center gap-1 truncate">
                                        <span class="truncate">PR Title</span> ${getSortIcon('title')}
                                    </div>
                                </th>
                                <th class="cursor-pointer px-2 py-3 hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="repo_owner" style="min-width: 140px;" title="Click to sort by Repository. Shift+Click to set as secondary sort.&#10;Stored in database (extracted from PR URL when added)">
                                    <div class="flex items-center gap-1 truncate">
                                        <span class="truncate">Repository</span> ${getSortIcon('repo_owner')}
                                    </div>
                                </th>
                                <th class="cursor-pointer px-2 py-3 hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="review_status" style="min-width: 90px;" title="Click to sort by Review. Shift+Click to set as secondary sort.&#10;API: GET /repos/{owner}/{repo}/pulls/{pr_number}/reviews (latest state per reviewer)">
                                    <div class="flex items-center gap-1 truncate">
                                        <span class="truncate">Review</span> ${getSortIcon('review_status')}
                                    </div>
                                </th>
                                <th class="cursor-pointer px-2 py-3 hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="mergeable_state" style="min-width: 90px;" title="Click to sort by Mergeable. Shift+Click to set as secondary sort.&#10;API: GET /repos/{owner}/{repo}/pulls/{pr_number} (mergeable_state field)">
                                    <div class="flex items-center gap-1 truncate">
                                        <span class="truncate">Mergeable</span> ${getSortIcon('mergeable_state')}
                                    </div>
                                </th>
                                <th class="cursor-pointer px-2 py-3 hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="files_changed" style="min-width: 60px;" title="Click to sort by Files. Shift+Click to set as secondary sort.&#10;API: GET /repos/{owner}/{repo}/pulls/{pr_number}/files (count of files)">
                                    <div class="flex items-center gap-1 truncate">
                                        <span class="truncate">Files</span> ${getSortIcon('files_changed')}
                                    </div>
                                </th>
                                <th class="cursor-pointer px-2 py-3 hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="commits_count" style="min-width: 70px;" title="Click to sort by Commits. Shift+Click to set as secondary sort.&#10;API: GET /repos/{owner}/{repo}/pulls/{pr_number} (commits field)">
                                    <div class="flex items-center gap-1 truncate">
                                        <span class="truncate">Commits</span> ${getSortIcon('commits_count')}
                                    </div>
                                </th>
                                <th class="cursor-pointer px-2 py-3 hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="behind_by" style="min-width: 70px;" title="Click to sort by Behind. Shift+Click to set as secondary sort.&#10;API: GET /repos/{owner}/{repo}/compare/{base}...{head} (behind_by field) - Shows commits behind base branch">
                                    <div class="flex items-center gap-1 truncate">
                                        <span class="truncate">Behind</span> ${getSortIcon('behind_by')}
                                    </div>
                                </th>
                                <th class="cursor-pointer px-2 py-3 hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="checks_passed" style="min-width: 90px;" title="Click to sort by Checks. Shift+Click to set as secondary sort.&#10;API: GET /repos/{owner}/{repo}/commits/{sha}/check-runs (conclusion field)">
                                    <div class="flex items-center gap-1 truncate">
                                        <span class="truncate">Checks</span> ${getSortIcon('checks_passed')}
                                    </div>
                                </th>
                                <th class="cursor-pointer px-2 py-3 text-center hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="ready_score" style="min-width: 70px;" title="Click to sort by Ready. Shift+Click to set as secondary sort.&#10;Overall Readiness Score - Calculated: (CI Score * 45%) + (Review Score * 55%)">
                                    <div class="flex items-center justify-center gap-1 truncate">
                                        <span class="truncate">Ready</span> ${getSortIcon('ready_score')}
                                    </div>
                                </th>
                                <th class="cursor-pointer px-2 py-3 text-center hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="ci_score" style="min-width: 50px;" title="Click to sort by CI. Shift+Click to set as secondary sort.&#10;CI Score - Calculated from check-runs API based on pass/fail/skip counts">
                                    <div class="flex items-center justify-center gap-1 truncate">
                                        <span class="truncate">CI</span> ${getSortIcon('ci_score')}
                                    </div>
                                </th>
                                <th class="cursor-pointer px-2 py-3 text-center hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="review_score" style="min-width: 60px;" title="Click to sort by Review. Shift+Click to set as secondary sort.&#10;Review Score - Calculated from timeline analysis (commits, reviews, comments)">
                                    <div class="flex items-center justify-center gap-1 truncate">
                                        <span class="truncate">Review</span> ${getSortIcon('review_score')}
                                    </div>
                                </th>
                                <th class="cursor-pointer px-2 py-3 text-center hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="response_score" style="min-width: 70px;" title="Click to sort by Response. Shift+Click to set as secondary sort.&#10;Response Rate - Calculated from timeline analysis using GET /repos/{owner}/{repo}/pulls/{pr_number}/commits and GET /repos/{owner}/{repo}/issues/{pr_number}/comments">
                                    <div class="flex items-center justify-center gap-1 truncate">
                                        <span class="truncate">Response</span> ${getSortIcon('response_score')}
                                    </div>
                                </th>
                                <th class="cursor-pointer px-2 py-3 text-center hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="feedback_score" style="min-width: 80px;" title="Click to sort by Feedback. Shift+Click to set as secondary sort.&#10;Feedback Responded/Total - Calculated from GET /repos/{owner}/{repo}/pulls/{pr_number}/comments (review comments on diff)">
                                    <div class="flex items-center justify-center gap-1 truncate">
                                        <span class="truncate">Feedback</span> ${getSortIcon('feedback_score')}
                                    </div>
                                </th>
                                <th class="cursor-pointer px-2 py-3 hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="issues_count" style="min-width: 200px;" title="Click to sort by Issues. Shift+Click to set as secondary sort.&#10;Blockers, Warnings, and Recommendations - Calculated from readiness analysis combining all API data">
                                    <div class="flex items-center gap-1 truncate">
                                        <span class="truncate">Issues</span> ${getSortIcon('issues_count')}
                                    </div>
                                </th>
                                <th class="cursor-pointer px-2 py-3 hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="last_updated_at" style="min-width: 90px;" title="Click to sort by Updated. Shift+Click to set as secondary sort.&#10;API: GET /repos/{owner}/{repo}/pulls/{pr_number} (updated_at field)">
                                    <div class="flex items-center gap-1 truncate">
                                        <span class="truncate">Updated</span> ${getSortIcon('last_updated_at')}
                                    </div>
                                </th>
                                <th class="px-2 py-3 text-center" style="min-width: 100px;" title="UI actions: Refresh PR data, Check Readiness, Remove from tracking">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-200 dark:divide-slate-700" id="prTableBody">
                        </tbody>
                    </table>
                </div>
            `;

            // Add event delegation for sortable table headers
            const tableElement = container.querySelector('table');
            if (tableElement) {
                tableElement.addEventListener('click', (e) => {
                    // Find the closest th with data-sort-column attribute
                    const th = e.target.closest('th[data-sort-column]');
                    if (th) {
                        const column = th.getAttribute('data-sort-column');
                        const isShiftClick = e.shiftKey;
                        sortPrs(column, isShiftClick);
                    }
                });
            }

            const tbody = document.getElementById('prTableBody');
            allPrs.forEach(pr => {
                const row = createPrRow(pr);
                tbody.appendChild(row);

                // Load and display stored readiness data if available
                const storedData = loadReadinessData(pr.id);
                if (storedData && storedData.readiness && storedData.reviewHealth) {
                    updateInlineCells(pr.id, storedData.readiness, storedData.reviewHealth);
                    // Update button to show it was updated
                    const updateBtn = row.querySelector('.update-btn');
                    if (updateBtn) {
                        updateBtn.innerHTML = '<i class="fas fa-check mr-1"></i>Updated';
                    }
                }
            });

            document.querySelectorAll('.update-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const prId = e.currentTarget.dataset.prId;
                    await updatePr(prId, e.currentTarget);
                });
            });
        }

        function createPrRow(pr) {
            let stateBadge = '';
            if (pr.is_merged) {
                stateBadge = '<span class="inline-flex rounded-full border border-[#f5b0b0] bg-[#fff1f1] px-2 py-0.5 text-xs font-semibold text-[#BC0000] dark:border-red-900 dark:bg-red-950/30 dark:text-red-400">Merged</span>';
            } else if (pr.is_draft == 1) {
                stateBadge = '<span class="inline-flex rounded-full border border-slate-200 bg-slate-50 px-2 py-0.5 text-xs font-semibold text-slate-700 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-400">Draft</span>';
            }else if (pr.state === 'open') {
                stateBadge = '<span class="inline-flex rounded-full border border-emerald-200 bg-emerald-50 px-2 py-0.5 text-xs font-semibold text-emerald-700 dark:border-emerald-900 dark:bg-emerald-950/30 dark:text-emerald-400">Open</span>';
            } else {
                stateBadge = '<span class="inline-flex rounded-full border border-red-200 bg-red-50 px-2 py-0.5 text-xs font-semibold text-red-700 dark:border-red-900 dark:bg-red-950/30 dark:text-red-400">Closed</span>';
            }

            let reviewBadge = '';
            if (pr.review_status === 'approved') {
                reviewBadge = '<span class="inline-flex rounded-full border border-emerald-200 bg-emerald-50 px-2 py-0.5 text-xs font-semibold text-emerald-700 dark:border-emerald-900 dark:bg-emerald-950/30 dark:text-emerald-400">Approved</span>';
            } else if (pr.review_status === 'changes_requested') {
                reviewBadge = '<span class="inline-flex rounded-full border border-red-200 bg-red-50 px-2 py-0.5 text-xs font-semibold text-red-700 dark:border-red-900 dark:bg-red-950/30 dark:text-red-400">Changes</span>';
            } else if (pr.review_status === 'pending') {
                reviewBadge = '<span class="inline-flex rounded-full border border-amber-200 bg-amber-50 px-2 py-0.5 text-xs font-semibold text-amber-700 dark:border-amber-900 dark:bg-amber-950/30 dark:text-amber-400">Pending</span>';
            } else {
                reviewBadge = '<span class="inline-flex rounded-full border border-slate-200 bg-slate-100 px-2 py-0.5 text-xs font-semibold text-slate-600 dark:border-slate-700 dark:bg-slate-700 dark:text-slate-300">None</span>';
            }

            let mergeableText = pr.mergeable_state || 'unknown';
            if (mergeableText === 'clean') mergeableText = 'Ready';
            else if (mergeableText === 'dirty') mergeableText = 'Conflicts';
            else if (mergeableText === 'blocked') mergeableText = 'Blocked';
            else if (mergeableText === 'unstable') mergeableText = 'Unstable';

            const avatarUrl = pr.author_avatar &&
                (pr.author_avatar.startsWith('https://avatars.githubusercontent.com/') || pr.author_avatar.startsWith('https://github.com/'))
                ? pr.author_avatar
                : 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="32" height="32"%3E%3Crect width="32" height="32" fill="%23E2E8F0"/%3E%3C/svg%3E';

            const repoOwnerAvatarUrl = pr.repo_owner_avatar &&
                (pr.repo_owner_avatar.startsWith('https://avatars.githubusercontent.com/') || pr.repo_owner_avatar.startsWith('https://github.com/'))
                ? pr.repo_owner_avatar
                : 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="32" height="32"%3E%3Crect width="32" height="32" fill="%23E2E8F0"/%3E%3C/svg%3E';

            // Truncate title to first 20 characters
            const truncatedTitle = pr.title && pr.title.length > 20 ? pr.title.substring(0, 20) + '...' : pr.title;

            const row = document.createElement('tr');
            row.className = 'hover:bg-slate-50 dark:hover:bg-slate-900/50';
            row.id = `pr-row-${pr.id}`;
            row.innerHTML = `
                <td class="px-2 py-3">
                    <div class="flex items-center gap-2 min-w-0">
                        <img src="${escapeHtml(avatarUrl)}" alt="${escapeHtml(pr.author_login)}" class="h-6 w-6 rounded-full border border-slate-200 dark:border-slate-600 flex-shrink-0" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2224%22 height=%2224%22%3E%3Crect width=%2224%22 height=%2224%22 fill=%22%23E2E8F0%22/%3E%3C/svg%3E'">
                        <span class="text-slate-600 dark:text-slate-400 text-xs truncate">${escapeHtml(pr.author_login)}</span>
                    </div>
                </td>
                <td class="px-2 py-3">
                    <div class="flex items-center gap-2 min-w-0">
                        <img src="${escapeHtml(repoOwnerAvatarUrl)}" alt="${escapeHtml(pr.repo_owner)}" class="h-6 w-6 rounded-full border border-slate-200 dark:border-slate-600 flex-shrink-0" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2224%22 height=%2224%22%3E%3Crect width=%2224%22 height=%2224%22 fill=%22%23E2E8F0%22/%3E%3C/svg%3E'">
                        <a href="${escapeHtml(pr.pr_url)}" target="_blank" rel="noopener noreferrer" class="font-medium text-slate-900 hover:text-[#BC0000] dark:text-slate-100 dark:hover:text-red-400 truncate text-xs" title="${escapeHtml(pr.title)}">${escapeHtml(truncatedTitle)}</a>
                    </div>
                </td>
                <td class="px-2 py-3 text-slate-600 dark:text-slate-400">
                    <div class="truncate text-xs">${escapeHtml(pr.repo_owner)}/${escapeHtml(pr.repo_name)}</div>
                    <div class="text-xs text-slate-500 dark:text-slate-500">#${pr.pr_number}</div>
                </td>
                <td class="px-2 py-3">${reviewBadge}</td>
                <td class="px-2 py-3 text-slate-700 dark:text-slate-300 text-xs truncate">${escapeHtml(mergeableText)}</td>
                <td class="px-2 py-3 text-center text-slate-700 dark:text-slate-300 text-xs">${pr.files_changed}</td>
                <td class="px-2 py-3 text-center text-slate-700 dark:text-slate-300 text-xs">${pr.commits_count || 0}</td>
                <td class="px-2 py-3 text-center text-slate-700 dark:text-slate-300 text-xs">
                    ${pr.behind_by > 0 ? `<span class="inline-flex items-center gap-1 rounded border border-amber-200 bg-amber-50 px-1.5 py-0.5 text-amber-700 dark:border-amber-900 dark:bg-amber-950/30 dark:text-amber-400" title="This PR is ${pr.behind_by} commit${pr.behind_by !== 1 ? 's' : ''} behind the base branch">
                        <i class="fas fa-exclamation-triangle"></i>${pr.behind_by}
                    </span>` : `<span class="inline-flex items-center gap-1 rounded border border-emerald-200 bg-emerald-50 px-1.5 py-0.5 text-emerald-700 dark:border-emerald-900 dark:bg-emerald-950/30 dark:text-emerald-400" title="This PR is up to date with the base branch">
                        <i class="fas fa-check"></i>
                    </span>`}
                </td>
                <td class="px-2 py-3">
                    <div class="flex flex-wrap gap-1 text-xs">
                        <span class="inline-flex items-center gap-1 rounded border border-emerald-200 bg-emerald-50 px-1.5 py-0.5 text-emerald-700 dark:border-emerald-900 dark:bg-emerald-950/30 dark:text-emerald-400">
                            <i class="fas fa-check-circle"></i>${pr.checks_passed}
                        </span>
                        ${pr.checks_failed > 0 ? `<a href="https://github.com/${escapeHtml(pr.repo_owner)}/${escapeHtml(pr.repo_name)}/pull/${escapeHtml(String(pr.pr_number))}/checks" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1 rounded border border-red-200 bg-red-50 px-1.5 py-0.5 text-red-700 hover:border-red-300 dark:border-red-900 dark:bg-red-950/30 dark:text-red-400">
                            <i class="fas fa-times-circle"></i>${escapeHtml(String(pr.checks_failed))}
                        </a>` : `<span class="inline-flex items-center gap-1 rounded border border-red-200 bg-red-50 px-1.5 py-0.5 text-red-700 dark:border-red-900 dark:bg-red-950/30 dark:text-red-400">
                            <i class="fas fa-times-circle"></i>${pr.checks_failed}
                        </span>`}
                        ${pr.checks_skipped > 0 ? `<span class="inline-flex items-center gap-1 rounded border border-slate-200 bg-slate-100 px-1.5 py-0.5 text-slate-600 dark:border-slate-700 dark:bg-slate-700 dark:text-slate-400">
                            <i class="fas fa-minus-circle"></i>${pr.checks_skipped}
                        </span>` : ''}
                    </div>
                </td>
                <td class="px-2 py-3 text-center" id="readiness-overall-${pr.id}">
                    <span class="text-xs text-slate-400 dark:text-slate-500">-</span>
                </td>
                <td class="px-2 py-3 text-center" id="readiness-ci-${pr.id}">
                    <span class="text-xs text-slate-400 dark:text-slate-500">-</span>
                </td>
                <td class="px-2 py-3 text-center" id="readiness-review-${pr.id}">
                    <span class="text-xs text-slate-400 dark:text-slate-500">-</span>
                </td>
                <td class="px-2 py-3 text-center" id="readiness-response-${pr.id}">
                    <span class="text-xs text-slate-400 dark:text-slate-500">-</span>
                </td>
                <td class="px-2 py-3 text-center" id="readiness-feedback-${pr.id}">
                    <span class="text-xs text-slate-400 dark:text-slate-500">-</span>
                </td>
                <td class="px-2 py-3" id="readiness-issues-${pr.id}">
                    <span class="text-xs text-slate-400 dark:text-slate-500">-</span>
                </td>
                <td class="px-2 py-3 text-xs text-slate-600 dark:text-slate-400 truncate">${escapeHtml(timeAgo(pr.last_updated_at))}</td>
                <td class="px-2 py-3 text-center">
                    <button class="update-btn rounded-md border border-[#E10000] bg-white px-3 py-2 text-xs font-semibold text-[#E10000] hover:bg-[#fff1f1] dark:border-red-700 dark:bg-slate-700 dark:text-red-400 dark:hover:bg-red-950/30" data-pr-id="${pr.id}" title="Update PR data and analyze readiness">
                        <i class="fas fa-sync mr-1"></i>Update
                    </button>
                </td>
            `;
            return row;
        }

        function updateSinglePrRow(prId, prData) {
            // Find and update the PR in allPrs array
            const prIndex = allPrs.findIndex(pr => pr.id === prId);
            if (prIndex !== -1) {
                // Preserve the id from the existing PR
                allPrs[prIndex] = { ...prData, id: prId };
            }

            // Get the existing row
            const existingRow = document.getElementById(`pr-row-${prId}`);
            if (!existingRow) return;

            // Create new row with updated data
            const newRow = createPrRow({ ...prData, id: prId });
            
            // Replace the old row with the new one
            existingRow.replaceWith(newRow);

            // Re-attach the click event listener to the new button
            const updateBtn = newRow.querySelector('.update-btn');
            if (updateBtn) {
                updateBtn.addEventListener('click', async (e) => {
                    await updatePr(prId, e.currentTarget);
                });
            }
        }

        async function updatePr(prId, button) {
            const originalHtml = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Updating...';
            button.classList.add('opacity-70', 'cursor-not-allowed');

            try {
                // Step 1: Refresh PR data from GitHub
                const refreshResponse = await fetch('/api/refresh', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ pr_id: prId })
                });

                const refreshData = await refreshResponse.json();
                if (refreshData.error) {
                    showInlineError(`pr-row-${prId}`, refreshData.error);
                    return;
                }

                // Clear cached readiness data for this PR since it's being refreshed
                clearReadinessData(prId);
                
                // Check if PR was removed due to being merged/closed
                if (refreshData.removed) {
                    // Remove PR from allPrs array
                    const prIndex = allPrs.findIndex(pr => pr.id === prId);
                    if (prIndex !== -1) {
                        allPrs.splice(prIndex, 1);
                    }
                    
                    // Get the row element
                    const row = document.getElementById(`pr-row-${prId}`);
                    if (row) {
                        // Add fade-out animation
                        row.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
                        row.style.opacity = '0';
                        row.style.transform = 'translateX(20px)';
                        
                        // Remove the row after animation completes
                        setTimeout(async () => {
                            row.remove();
                            
                            // Update repos list (counts might have changed)
                            await loadRepos();
                            
                            // Check if there are no PRs left
                            if (allPrs.length === 0) {
                                const container = document.getElementById('prListContainer');
                                if (container) {
                                    container.innerHTML = '<div class="rounded-xl border border-dashed border-slate-300 bg-white p-10 text-center dark:border-slate-600 dark:bg-slate-800"><h3 class="text-xl font-semibold text-slate-900 dark:text-slate-100">No PRs Added Yet</h3><p class="mt-2 text-sm text-slate-500 dark:text-slate-400">Add a GitHub PR URL above to start tracking</p></div>';
                                }
                            }
                        }, 300);
                    }
                    
                    // Show success message
                    showError(refreshData.message || 'PR has been closed and removed from tracking');
                    await loadRateLimit();
                    return;
                }

                // Update only this PR row with fresh data
                updateSinglePrRow(prId, refreshData.data);
                await loadRateLimit();

                // Get the new button reference after row update
                const updatedRow = document.getElementById(`pr-row-${prId}`);
                const updatedButton = updatedRow ? updatedRow.querySelector('.update-btn') : null;
                if (!updatedButton) {
                    console.error('Could not find updated button');
                    return;
                }

                // Step 2: Analyze readiness
                const readinessResponse = await fetch(`/api/prs/${prId}/readiness`);
                const readinessData = await readinessResponse.json();
                
                if (readinessData.error) {
                    showInlineError(`pr-row-${prId}`, readinessData.error);
                    return;
                }

                const readiness = readinessData.readiness;
                const reviewHealth = readinessData.review_health;

                // Save readiness data to localStorage
                saveReadinessData(prId, readiness, reviewHealth);

                // Update all inline cells with readiness data
                updateInlineCells(prId, readiness, reviewHealth);
                
                updatedButton.innerHTML = '<i class="fas fa-check mr-1"></i>Updated';
                updatedButton.disabled = false;
                updatedButton.classList.remove('opacity-70', 'cursor-not-allowed');
            } catch (error) {
                console.error('Error updating PR:', error);
                showInlineError(`pr-row-${prId}`, 'Failed to update PR');
            }
        }

        function updateInlineCells(prId, readiness, reviewHealth) {
            // Score color classes helper
            const getScoreColor = (score) => {
                if (score >= 70) return 'text-emerald-700 dark:text-emerald-400';
                if (score >= 60) return 'text-amber-600 dark:text-amber-400';
                if (score >= 40) return 'text-orange-600 dark:text-orange-400';
                return 'text-red-600 dark:text-red-400';
            };

            // Update Overall readiness
            const overallCell = document.getElementById(`readiness-overall-${prId}`);
            if (overallCell) {
                const icon = readiness.merge_ready ? '' : '';
                const scoreClass = getScoreColor(readiness.overall_score);
                overallCell.innerHTML = `
                    <div class="flex flex-col items-center">
                        <span class="text-base">${icon}</span>
                        <span class="${scoreClass} text-xs font-bold">${readiness.overall_score_display}</span>
                    </div>
                `;
            }

            // Update CI score
            const ciCell = document.getElementById(`readiness-ci-${prId}`);
            if (ciCell) {
                const scoreClass = getScoreColor(readiness.ci_score);
                ciCell.innerHTML = `<span class="${scoreClass} text-xs font-bold">${readiness.ci_score_display}</span>`;
            }

            // Update Review score
            const reviewCell = document.getElementById(`readiness-review-${prId}`);
            if (reviewCell) {
                const scoreClass = getScoreColor(readiness.review_score);
                reviewCell.innerHTML = `<span class="${scoreClass} text-xs font-bold">${readiness.review_score_display}</span>`;
            }

            // Update Response rate
            const responseCell = document.getElementById(`readiness-response-${prId}`);
            if (responseCell) {
                const responseScore = parseFloat(reviewHealth.response_rate_display.replace('%', ''));
                const scoreClass = getScoreColor(responseScore);
                responseCell.innerHTML = `<span class="${scoreClass} text-xs font-bold">${reviewHealth.response_rate_display}</span>`;
            }

            // Update Feedback
            const feedbackCell = document.getElementById(`readiness-feedback-${prId}`);
            if (feedbackCell) {
                const feedbackPercent = reviewHealth.total_feedback > 0 ? 
                    (reviewHealth.responded_feedback / reviewHealth.total_feedback) * 100 : 100;
                const scoreClass = getScoreColor(feedbackPercent);
                feedbackCell.innerHTML = `<span class="${scoreClass} text-xs font-bold">${reviewHealth.responded_feedback}/${reviewHealth.total_feedback}</span>`;
            }

            // Update Issues/Blockers column
            const issuesCell = document.getElementById(`readiness-issues-${prId}`);
            if (issuesCell) {
                let issuesHTML = '<div class="text-xs space-y-0.5">';
                let hasIssues = false;

                // Show blockers
                if (readiness.blockers && readiness.blockers.length > 0) {
                    hasIssues = true;
                    issuesHTML += `<div class="flex items-start gap-1 text-red-700 dark:text-red-400">`;
                    issuesHTML += `<span class="font-bold"></span>`;
                    issuesHTML += `<span class="truncate" title="${escapeHtml(readiness.blockers.join('; '))}">${escapeHtml(readiness.blockers[0])}</span>`;
                    if (readiness.blockers.length > 1) {
                        issuesHTML += `<span class="font-semibold">+${readiness.blockers.length - 1}</span>`;
                    }
                    issuesHTML += `</div>`;
                }

                // Show warnings
                if (readiness.warnings && readiness.warnings.length > 0) {
                    hasIssues = true;
                    issuesHTML += `<div class="flex items-start gap-1 text-amber-700 dark:text-amber-400">`;
                    issuesHTML += `<span class="font-bold"></span>`;
                    issuesHTML += `<span class="truncate" title="${escapeHtml(readiness.warnings.join('; '))}">${escapeHtml(readiness.warnings[0])}</span>`;
                    if (readiness.warnings.length > 1) {
                        issuesHTML += `<span class="font-semibold">+${readiness.warnings.length - 1}</span>`;
                    }
                    issuesHTML += `</div>`;
                }

                // Show recommendations
                if (readiness.recommendations && readiness.recommendations.length > 0) {
                    hasIssues = true;
                    issuesHTML += `<div class="flex items-start gap-1 text-blue-700 dark:text-blue-400">`;
                    issuesHTML += `<span class="font-bold"></span>`;
                    issuesHTML += `<span class="truncate" title="${escapeHtml(readiness.recommendations.join('; '))}">${escapeHtml(readiness.recommendations[0])}</span>`;
                    if (readiness.recommendations.length > 1) {
                        issuesHTML += `<span class="font-semibold">+${readiness.recommendations.length - 1}</span>`;
                    }
                    issuesHTML += `</div>`;
                }

                if (!hasIssues) {
                    issuesHTML += '<span class="text-emerald-600 dark:text-emerald-400 font-semibold"> All Clear</span>';
                }

                issuesHTML += '</div>';
                issuesCell.innerHTML = issuesHTML;
            }
        }

        async function addPr() {
            const input = document.getElementById('prUrlInput');
            const btn = document.getElementById('addPrBtn');
            const checkbox = document.getElementById('addAllPrsCheckbox');
            const prUrl = input.value.trim();
            const addAll = checkbox.checked;

            if (!prUrl) {
                showInputError('prUrlInput', 'Please enter a PR URL');
                return;
            }

            btn.disabled = true;
            btn.textContent = addAll ? 'Importing...' : 'Adding...';

            try {
                // If importing all, handle logic to send repo_url appropriately
                // But preserving your existing logic structure:
                const response = await fetch('/api/prs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        pr_url: prUrl,
                        add_all: addAll
                    })
                });

                const data = await response.json();
                if (data.error) {
                    showInputError('prUrlInput', data.error);
                } else {
                    input.value = '';
                    await loadRepos();
                    await loadPrs();
                    await loadRateLimit();
                }
            } catch (error) {
                console.error('Error adding PR:', error);
                showInputError('prUrlInput', 'Failed to add PR');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Add PR';
            }
        }

        // Search listener
        document.getElementById('prSearchInput').addEventListener('input', (e) => {
            filterPrs(e.target.value);
        });

        document.getElementById('addPrBtn').addEventListener('click', addPr);
        document.getElementById('prUrlInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addPr();
        });

        document.querySelector('[data-repo="all"]').addEventListener('click', () => {
            currentRepo = 'all';
            localStorage.setItem('currentRepo', currentRepo);
            document.querySelectorAll('.repo-item').forEach(item => {
                setRepoItemActiveState(item, item.dataset.repo === currentRepo);
            });
            loadPrs();
        });

        // Theme toggle functionality
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = savedTheme || (prefersDark ? 'dark' : 'light');
            
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                document.getElementById('themeIcon').className = 'fas fa-sun';
            } else {
                document.documentElement.classList.remove('dark');
                document.getElementById('themeIcon').className = 'fas fa-moon';
            }
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.contains('dark');
            const themeIcon = document.getElementById('themeIcon');
            
            if (isDark) {
                document.documentElement.classList.remove('dark');
                themeIcon.className = 'fas fa-moon';
                localStorage.setItem('theme', 'light');
            } else {
                document.documentElement.classList.add('dark');
                themeIcon.className = 'fas fa-sun';
                localStorage.setItem('theme', 'dark');
            }
        }

        document.getElementById('themeToggle').addEventListener('click', toggleTheme);

        // Make sortPrs globally accessible for onclick handlers
        window.sortPrs = sortPrs;

        initTheme();
        loadRateLimit();
        loadLatestRelease();
        loadRepos();
        loadPrs();
        setInterval(loadRateLimit, 600000);
    </script>
</body>
</html>